{{ define "title" }} Convox {{ end }}

{{ define "body" }}

  {{ $app := . }}

	<div id="alert" class="alert alert-danger  alert-dismissible" role="alert" style="display:none;">
		<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		<strong>Error:</strong><span class="message"></span>
	</div>

	<ol class="breadcrumb">
		<button id="destroy-app" class="btn btn-danger btn-xs trackable">Destroy App</button>
		<button id="build-app" class="btn btn-success btn-xs trackable">Build</button>
		<li><a href="/apps">Apps</a></li>
		<li class="active">{{ .Name }}</li>
	</ol>

	<div class="panel panel-default">
		<div class="panel-body">
			{{ label "Status" .Status }}
			{{ label "Repository" .Repository }}
			{{ label "Host" .BalancerHost }}
			<div class="labelled-value">
				<span class="name">Check</span>
				<span class="value">
					<div id="healthcheck">{{ .HealthCheckEndpoint }}{{ .HealthCheckPath }}</div>
					<form id="healthcheck-edit" class="form-inline" method="post" action="/apps/{{ .Name }}" style="display:none">
						<div class="form-group">
							<select class="form-control input-sm" name="healthcheck[endpoint]">
								{{ dropdown .HealthCheckEndpoints .HealthCheckEndpoint }}
							</select>
						</div>
						<div class="form-group">
							<input class="form-control input-sm" type="text" name="healthcheck[path]" value="{{ .HealthCheckPath }}">
						</div>
						<input id="healthcheck-edit-cancel" type="button" class="btn btn-xs" value="Cancel">
						<input type="submit" class="btn btn-xs btn-primary" value="Update">
					</form>
				</span>
			</div>
		</div>
	</div>

	{{ if .Created }}

		<div class="table-title">
			<table class="table table-striped table-bordered">
				<thead>
					<tr class="title">
						<th colspan="7">
							Processes
						</th>
					</tr>
					<tr>
						<th class="expand">Name</th>
						<th>Ports</th>
						<th>Count</th>
						<th>CPU</th>
						<th>Memory</th>
						<th>Disk</th>
					</tr>
				</thead>
				<tbody>
					{{ range .Processes }}
						<tr>
							<td class="meta-buttons">
								<a href="/apps/{{ .App }}/processes/{{ .Name }}">
									{{ .Name }}
								</a>

								{{ if .ServiceType }}
									<button class="btn btn-xs btn-info service-link pull-right" title="Service for {{ .Name }}" data-app="{{ .App }}" data-name="{{ .Name }}" data-type="{{ .ServiceType }}" data-toggle="modal" data-target="#service-link">Link</button>
								{{ end }}
							</td>
							<td>
								{{ range $port, $url := ($app.BalancerPorts .Name) }}
									<a target="preview" href="http://{{ $url }}" class="btn btn-xs btn-primary glyph">
										{{ $port }}
									</a>
								{{ end }}
							</td>
							<td class="text-center">{{.Count}}</td>
							{{ $metrics := .Metrics }}
							<td>{{ meter "cpu"    $metrics.Cpu    100 }}</td>
							<td>{{ meter "memory" $metrics.Memory 100 }}</td>
							<td>{{ meter "disk"   $metrics.Disk   100 }}</td>
						</tr>
					{{ end }}
				</tbody>
			</table>
		</div>

		{{ if .Services }}
			<div class="table-title">
				<table class="table table-striped table-bordered">
					<thead>
						<tr class="title">
							<th colspan="1">
								Services
							</th>
						</tr>
						<tr>
							<th class="expand">Name</th>
						</tr>
					</thead>
					<tbody>
						{{ range .Services }}
							<tr>
								<td class="meta-buttons">
									<a href="/services/{{ .Name }}">
										{{ .Name }}
									</a>
								</td>
							</tr>
						{{ end }}
					</tbody>
				</table>
			</div>
		{{ end }}

		<div class="nav-buttons pull-right">
			<img id="spinner" src="/spinner.gif">
			<a href="#" class="btn btn-xs btn-primary" id="refresh">Refresh</a>
		</div>

		<ul class="nav nav-tabs">
			<li role="presentation"><a href="#deployments" id="deployments-tab" class="trackable" role="tab" data-source="/apps/{{ .Name }}/deployments">Deployments</a></li>
			<li role="presentation"><a href="#logs" id="logs-tab" class="trackable" role="tab" data-source="/apps/{{ .Name }}/logs">Logs</a></li>
			<li role="presentation"><a href="#builds" id="builds-tab" class="trackable" role="tab" data-source="/apps/{{ .Name }}/builds">Builds</a></li>
			<li role="presentation"><a href="#environment" id="environment-tab" class="trackable" role="tab" data-source="/apps/{{ .Name }}/environment">Environment</a></li>
			<li role="presentation"><a href="#debug" id="debug-tab" class="trackable" role="tab" data-source="/apps/{{ .Name }}/events">Debug</a></li>
		</ul>

		<div id="tab-content">
		</div>

		<script>
			$(window).ready(function() {
				$('#healthcheck').on('click', function() {
					$('#healthcheck').hide();
					$('#healthcheck-edit').show();
				});

				$('#healthcheck-edit-cancel').on('click', function() {
					$('#healthcheck-edit').hide();
					$('#healthcheck').show();
				});

				$('#build-app').on('click', function() {
					var button = $(this);

					button.prop('disabled', true);

					window.setTimeout(function() {
						button.prop('disabled', false);
					}, 500);

					$.ajax({ type: 'POST', url:'/apps/{{ .Name }}/build', data: { repo: '{{ .Repository }}' }}).done(function(msg) {
						change_to_tab('#builds');
					}).fail(function(msg) {
						$('#alert .message').html(msg.responseText);
						$('#alert').show();
					});
				});

				$('#destroy-app').on('click', function() {
					$.ajax({ type: 'DELETE', url:'/apps/{{ .Name }}'}).done(function(msg) {
						window.location = '/apps';
					}).fail(function(msg) {
						$('#alert .message').html(msg.responseText);
						$('#alert').show();
					});
				});

				window.setInterval(function() {
					$.ajax({ url:'/apps/{{ .Name }}/status' }).done(function(data) {
						$('#label-status .value').text(data);
					});
				}, 10000);

				$('.service-link').on('click', function() {
					var app = $(this).data("app")
					var name = $(this).data("name")
					var type = $(this).data("type")
					// var target = $(this).data("target")

					$('#service-link .modal-title').html("Link Service for " + name)

					$('#service-link form').attr("action", "/apps/" + app + "/services");
					$('#service-link-app').val(app)
					$('#service-link-name').val(name)
					$('#service-link-type').val(type)

					$('#service-link-stack').html("")

					$.ajax({ type: 'GET', url:'/services/types/' + type }).done(function(msg) {
						$('#service-link-stack').html(msg)
					}).fail(function(msg) {
						$('#alert .message').html(msg.responseText);
						$('#alert').show();
					});

					mixpanel.track('service-link-click');
				})

				goto_anchor('#deployments');
			});
		</script>

		{{ template "service" . }}

	{{ end }}

{{ end }}

{{ define "builds" }}
	<table class="table table-striped table-bordered">
		<thead>
			<tr>
				<th></th>
				<th>ID</th>
				<th>Reason</th>
				<th class="expand">Started</th>
				<th>Duration</th>
				<th colspan="2"></th>
			</tr>
		</thead>
		<tbody>
			{{ $active := .Active }}
			{{ range .Builds }}
				<tr>
					<td class="statusicon">{{ statusicon .Status }}</td>
					<td class="id">{{ .Id }}</td>
					<td>{{ .Reason }}</td>
					<td>{{ timeago .Started }}</td>
					<td>{{ duration .Started .Ended }}</td>
					<td class="buttons">
						<button class="btn btn-xs btn-info build-logs" title="Environment" data-toggle="modal" data-target="#build-environment-{{ .Id }}">Environment</button>
						<button class="btn btn-xs btn-info build-logs" title="Logs" data-toggle="modal" data-target="#build-logs-{{ .Id }}">Logs</button>
					</td>
					<td class="buttons">
						{{ if eq .Id $active }}
							<button class="btn btn-success btn-xs promote-build build-active" data-build="{{ .Id }}">Active</button>
						{{ else }}
							<button class="btn btn-warning btn-xs promote-build trackable" id="promote-build" data-build="{{ .Id }}">Promote</button>
						{{ end }}
					</td>
				</tr>
			{{ end }}
		</tbody>
	</table>
	{{ range .Builds }}
		<div id="build-logs-{{ .Id }}" class="modal fade">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Build Logs: {{ .Id }}</h4>
					</div>
					<div class="modal-body">
						<pre class="modal-scroll">{{ .Logs }}</pre>
					</div>
				</div>
			</div>
		</div>
	{{ end }}
	<script>
		$('.timeago').timeago();

		$('.promote-build').on('click', function() {
			$(this).prop('disabled', true);
			$('#spinner').show();

			$.ajax({ type:'POST', url:window.location.pathname+'/builds/'+$(this).data('build')+'/promote' }).done(function(msg) {
				$('#alert').hide();
				$('#spinner').hide();
				refresh_tab();
			}).fail(function(msg) {
				$('#alert .message').html(msg.responseText);
				$('#alert').show();
				$('#spinner').hide();
				refresh_tab();
			});
		});
	</script>
{{ end }}

{{ define "deployments" }}
	<div class="table-title">
		<table class="table table-striped table-bordered">
			<thead>
				<tr>
					<th class="expand">Release</th>
					<th>Status</th>
					<th>Desired</th>
					<th>Pending</th>
					<th>Running</th>
				</tr>
			</thead>
			<tbody>
				{{ range . }}
					<tr>
						<td class="id expand">{{ .Release }}</td>
						<td>{{ .Status }}</td>
						<td>{{ .Desired }}</td>
						<td>{{ .Pending }}</td>
						<td>{{ .Running }}</td>
					</tr>
				{{ end }}
			</tbody>
		</table>
	</div>
{{ end }}

{{ define "environment" }}
	<div id="environment-basic-content">
		<table class="table table-striped table-bordered app-environment">
			<thead>
				<tr>
					<th>Name</th>
					<th class="expand">Value</th>
					<th><button id="environment-raw" class="btn btn-inverse btn-xs trackable">Raw</button></th>
				</tr>
			</thead>
			<tfoot>
				<tr>
					<td><input type="text" name="name"></td>
					<td><input type="text" name="value"></td>
					<td><button id="environment-add" data-cluster="{{ .Cluster }}" data-app="{{ .App }}" class="btn btn-success btn-xs trackable">Add</button></td>
				</tr>
			</tfoot>
			<tbody>
				{{ $root := . }}
				{{ range .Environment.SortedNames }}
					<tr>
						<td>{{ . }}</td>
						<td class="wrap expand">{{ truncate (index $root.Environment .) 70 }}</td>
						<td>
							<button data-cluster="{{ $root.Cluster }}" data-app="{{ $root.App }}" data-name="{{ . }}" id="environment-delete" class="environment-delete btn btn-danger btn-xs trackable">Delete</button>
						</td>
					</tr>
				{{ end }}
			</tbody>
		</table>
	</div>
	<div id="environment-raw-content">
		<div class="panel">
			<textarea id="environment-content" class="environment">{{ .Environment.Raw }}</textarea>
			<div class="clearfix footer">
				<button id="environment-raw-save" class="btn btn-xs btn-primary pull-right trackable" data-cluster="{{ .Cluster }}" data-app="{{ .App }}">Save</button>
				<button id="environment-raw-cancel" class="btn btn-xs btn-inverse pull-right trackable">Cancel</button>
			</div>
		</div>
	</div>
{{ end }}

{{ define "events" }}
	<pre id="app-debug" class="logs">{{ range .Events }}{{ times .CreatedAt }} - {{ .Message }}
{{ end }}</pre>
{{ end }}

{{ define "logs" }}
	<pre id="app-logs" class="logs"><p>Connecting...</p></pre>
	<script>
		connect_log_socket($('#app-logs'), '/apps/{{ . }}/logs/stream');
	</script>
{{ end }}

{{ define "resources" }}
	<table class="table table-striped table-bordered app-resources">
		<thead>
			<tr>
				<th>Name</th>
				<th>Type</th>
				<th class="expand">Status</th>
				<th>Time</th>
			</tr>
		</thead>
		<tbody>
			{{ range . }}
				<tr>
					<td>{{ .Name }}</td>
					<td>{{ .Type }}</td>
					<td class="expand">{{ .Status }}</td>
					<td>{{ timeago .Time }}</td>
				</tr>
			{{ end }}
		</tbody>
	</table>
	<script>
		$('.timeago').timeago();

		table_scroll($('.app-resources'), '365px');

                mixpanel.track('page-viewed', {
                        'page name' : 'app',
                        'url' : window.location.pathname
                });

		$('button.build-logs').click(function() {
			mixpanel.track('build-logs-click');
		});
	</script>
{{ end }}

{{ define "service" }}
	<div class="modal fade" id="service-link" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form method="post" action="#" class="form-horizontal">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel">Link Service</h4>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<label for="service-link-app" class="col-sm-3 control-label">App</label>
							<div class="col-sm-8">
								<input name="app" type="text" class="form-control" id="service-link-app">
							</div>
						</div>
						<div class="form-group">
							<label for="service-link-name" class="col-sm-3 control-label">Name</label>
							<div class="col-sm-8">
								<input name="name" type="text" class="form-control" id="service-link-name">
							</div>
						</div>
						<div class="form-group">
							<label for="service-link-type" class="col-sm-3 control-label">Type</label>
							<div class="col-sm-8">
								<input name="type" type="text" class="form-control" id="service-link-type">
							</div>
						</div>
						<div class="form-group">
							<label for="stack" class="col-sm-3 control-label">Service Stack</label>
							<div class="col-sm-8">
								<select name="stack" class="form-control" id="service-link-stack">
								</select>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						<input type="submit" class="btn btn-primary" value="Link Service">
					</div>
				</form>
			</div>
		</div>
	</div>
{{ end }}
